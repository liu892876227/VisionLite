# VisionLite通讯模块完整测试方案

## 测试环境说明

### 测试工具
- **VisionLite应用**: 被测试的通讯模块
- **ZLAN TCP&UDP调试工具**: 作为外部通讯测试客户端/服务器
- **测试网络**: 本地网络 (192.168.x.x)

### 通讯模块功能概述
1. **TCP服务器模式**: VisionLite作为服务器，监听客户端连接
2. **TCP客户端模式**: VisionLite作为客户端，连接到外部服务器
3. **自定义协议**: VisionLiteProtocol，支持JSON和简单命令格式
4. **协议帧格式**: STX(1字节) + 长度(4字节) + 消息体(N字节) + CRC16(2字节) + ETX(1字节)

---

## 测试方案一：TCP服务器模式测试

### 1.1 基础连接测试

#### 测试目标
验证VisionLite TCP服务器的基本连接功能

#### VisionLite配置
1. 启动VisionLite应用
2. 打开通讯管理窗口
3. 添加TCP服务器连接：
   - 连接名称: `TCP_Server_Test`
   - 连接类型: TCP服务器
   - 监听地址: 0.0.0.0
   - 端口号: 8080
4. 点击"启动"按钮

#### ZLAN工具配置
1. 工作模式: **TCP客户端**
2. 目标IP: `127.0.0.1` (或VisionLite所在机器IP)
3. 目标端口: `8080`
4. 勾选"自动重连"
5. 点击"打开"建立连接

#### 预期结果
- VisionLite显示状态为"正在监听"
- ZLAN工具显示连接成功
- VisionLite客户端列表显示新连接的客户端IP:端口
- 连接数显示为1

---

### 1.2 消息发送测试

#### 测试目标
验证从ZLAN工具向VisionLite发送各种格式的消息

#### 测试用例1：简单命令格式
```
发送数据 (十六进制): 02 00 00 00 0F 48 45 41 52 54 42 45 41 54 7C 31 32 33 34 35 XX XX 03
对应文本: HEARTBEAT|12345
```

**构建步骤:**
1. 消息体: "HEARTBEAT|12345" (15字节)
2. STX: 02
3. 长度: 0F 00 00 00 (15的小端序)
4. 消息体: 48 45 41 52 54 42 45 41 54 7C 31 32 33 34 35
5. CRC16: 需要计算 (暂用XX XX占位)
6. ETX: 03

**ZLAN操作:**
1. 发送区设置: 十六进制发送
2. 输入上述十六进制数据
3. 点击"发送"

**预期结果:**
- VisionLite接收到HEARTBEAT命令
- 日志显示命令解析成功
- 显示消息ID为12345

#### 测试用例2：JSON格式消息
```json
{
  "cmd": "TRIGGER",
  "type": "Command",
  "id": "msg_001",
  "params": {
    "window": 1,
    "mode": "auto"
  },
  "timestamp": "2025-08-22T11:30:00"
}
```

**构建帧格式:**
1. 将JSON转为UTF-8字节
2. 按协议格式封装
3. 计算CRC16
4. 发送完整帧

---

### 1.3 多客户端连接测试

#### 测试目标
验证TCP服务器支持多个客户端同时连接

#### 测试步骤
1. 启动多个ZLAN工具实例
2. 每个实例使用不同的本地端口连接到VisionLite
3. 观察连接状态和客户端列表

#### 预期结果
- 支持多个客户端同时连接
- 客户端列表正确显示所有连接
- 连接数正确统计

---

## 测试方案二：TCP客户端模式测试

### 2.1 基础连接测试

#### ZLAN工具配置
1. 工作模式: **TCP服务器**
2. 本地端口: `8080`
3. 点击"打开"开始监听

#### VisionLite配置
1. 添加TCP客户端连接：
   - 连接名称: `TCP_Client_Test`
   - 连接类型: TCP客户端
   - IP地址: `127.0.0.1`
   - 端口号: `8080`
2. 点击"连接"按钮

#### 预期结果
- VisionLite显示状态为"已连接"
- ZLAN工具显示有客户端连接

### 2.2 消息接收测试

#### 测试目标
验证VisionLite客户端接收ZLAN发送的消息

#### 测试用例1：从ZLAN发送标准协议帧
使用相同的协议格式构建消息，从ZLAN发送到VisionLite

#### 测试用例2：发送各种命令类型
- SET_PARAMS: 参数设置命令
- GET_RESULT: 结果查询命令
- RESPONSE_OK: 响应消息

---

## 测试方案三：协议格式测试

### 3.1 协议帧结构验证

#### 测试目标
验证自定义协议的编码解码正确性

#### 手动构建测试帧

**示例1: 心跳消息**
```
STX: 0x02
长度: 0x09000000 (9字节，小端序)
消息体: "HEARTBEAT" (9字节)
CRC16: [计算得出]
ETX: 0x03
```

**CRC16计算方法:**
使用在线CRC计算器或自写程序，对消息体"HEARTBEAT"计算CRC-16-CCITT

### 3.2 错误处理测试

#### 测试用例1：CRC错误
1. 构建正确的协议帧
2. 故意修改CRC值
3. 发送到VisionLite
4. 验证是否正确丢弃错误帧

#### 测试用例2：帧格式错误
1. 发送缺少STX的数据
2. 发送缺少ETX的数据
3. 发送长度字段错误的数据
4. 验证协议解析的健壮性

#### 测试用例3：粘包测试
1. 连续发送多个完整帧
2. 发送分片的帧数据
3. 验证协议能否正确分离和重组

---

## 测试方案四：压力和稳定性测试

### 4.1 连接稳定性测试

#### 测试步骤
1. 建立连接后保持24小时
2. 定期发送心跳消息
3. 监控内存占用和连接状态

### 4.2 高频消息测试

#### 测试步骤
1. 设置ZLAN每秒发送10条消息
2. 持续发送1小时
3. 监控消息丢失率和处理延迟

### 4.3 大数据量测试

#### 测试步骤
1. 发送大尺寸的JSON消息(如10KB)
2. 验证大消息的正确接收和解析
3. 测试协议缓冲区的处理能力

---

## 测试方案五：实际业务场景测试

### 5.1 机器视觉业务流程测试

#### 模拟PLC通讯场景
```json
// 1. PLC发送触发命令
{
  "cmd": "TRIGGER",
  "type": "Command",
  "id": "trigger_001",
  "params": {
    "window": 1,
    "camera_id": "camera_01"
  }
}

// 2. VisionLite响应确认
{
  "cmd": "RESPONSE_OK",
  "type": "Response",
  "id": "response_001",
  "params": {
    "original_id": "trigger_001",
    "success": true,
    "result": "触发命令已执行"
  }
}

// 3. PLC查询结果
{
  "cmd": "GET_RESULT",
  "type": "Command",
  "id": "query_001",
  "params": {
    "window": 1
  }
}

// 4. VisionLite返回检测结果
{
  "cmd": "RESPONSE_OK",
  "type": "Response",
  "id": "result_001",
  "params": {
    "original_id": "query_001",
    "success": true,
    "result": "PASS",
    "score": 95.6,
    "defects": "无缺陷"
  }
}
```

### 5.2 参数设置场景测试

#### 相机参数设置
```json
{
  "cmd": "SET_PARAMS",
  "type": "Command",
  "id": "set_params_001",
  "params": {
    "ExposureTime": 1000,
    "Gain": 2.5,
    "TriggerMode": "Software"
  }
}
```

---

## 测试执行检查表

### 基础功能测试
- [ ] TCP服务器启动/停止
- [ ] TCP客户端连接/断开
- [ ] 单客户端消息收发
- [ ] 多客户端并发连接
- [ ] 消息协议编码解码
- [ ] JSON格式消息处理
- [ ] 简单命令格式处理

### 错误处理测试
- [ ] 网络断开重连
- [ ] 协议格式错误处理
- [ ] CRC校验错误处理
- [ ] 超大消息处理
- [ ] 内存泄漏检查

### 性能测试
- [ ] 连接建立时间
- [ ] 消息传输延迟
- [ ] 高频消息处理
- [ ] 长时间稳定性
- [ ] 资源占用监控

### 业务场景测试
- [ ] 完整的PLC交互流程
- [ ] 参数设置和查询
- [ ] 触发和结果返回
- [ ] 错误状态处理
- [ ] 超时机制验证

---

## 测试报告模板

### 测试结果记录
- **测试日期**: 
- **测试环境**: 
- **VisionLite版本**: 
- **ZLAN工具版本**: 

### 功能测试结果
| 测试项目 | 预期结果 | 实际结果 | 通过/失败 | 备注 |
|---------|---------|---------|----------|------|
| TCP服务器启动 | 成功监听端口 |  |  |  |
| 客户端连接 | 连接成功建立 |  |  |  |
| 消息发送 | 消息正确接收 |  |  |  |
| 协议解析 | 格式正确解析 |  |  |  |

### 性能测试结果
- **连接建立时间**: 
- **消息传输延迟**: 
- **最大并发连接数**: 
- **消息处理速度**: 

### 问题记录
1. **问题描述**: 
   **重现步骤**: 
   **解决方案**: 

### 测试总结
- **整体评价**: 
- **建议改进**: 
- **风险评估**: 

---

## 附录：常用测试数据

### CRC16计算示例
```
消息: "HEARTBEAT"
Hex: 48 45 41 52 54 42 45 41 54
CRC-16-CCITT: [需要计算]
```

### 标准测试帧
```
心跳帧: 02 09 00 00 00 48 45 41 52 54 42 45 41 54 XX XX 03
触发帧: 02 07 00 00 00 54 52 49 47 47 45 52 XX XX 03
```

### JSON测试数据
详见上述业务场景测试中的JSON示例。