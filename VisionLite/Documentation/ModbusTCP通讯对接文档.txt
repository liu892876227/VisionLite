=================================================================
          VisionLite ModbusTCP服务器通讯对接文档
=================================================================

文档信息：
    文档版本: v1.2
    创建日期: 2025-08-26
    系统名称: VisionLite 工业机器视觉系统
    通讯协议: ModbusTCP (IEC 61158-6)
    适用范围: PLC与视觉系统数据交换
    更新内容: 升级支持ABCD/BADC/CDAB/DCBA四种字节序格式

=================================================================
1. 服务器基本信息
=================================================================

1.1 连接参数
-----------------------------------------------------------------
参数名称          参数值              说明
-----------------------------------------------------------------
服务器IP          192.168.1.100      可根据现场网络配置调整
端口号            502                ModbusTCP标准端口
从站ID            1                  Modbus单元标识符
最大连接数        10                 支持多PLC同时连接
数据格式          大端序（可配置）    符合Modbus标准，可选小端序
字节序配置        大端序/小端序       适配不同PLC厂商要求

1.2 支持的功能码
-----------------------------------------------------------------
功能码    功能描述        支持状态
-----------------------------------------------------------------
0x01      读线圈         ✓ 支持
0x02      读离散输入     ✓ 支持
0x03      读保持寄存器   ✓ 支持
0x04      读输入寄存器   ✓ 支持
0x05      写单个线圈     ✓ 支持
0x06      写单个寄存器   ✓ 支持
0x0F      写多个线圈     ✓ 支持
0x10      写多个寄存器   ✓ 支持

=================================================================
2. 地址映射表
=================================================================

2.1 线圈区域 (Coil - 0x区域)
    用途：系统状态输出，PLC可读取视觉系统状态

-----------------------------------------------------------------
Modbus地址   PLC地址   变量名称      数据类型   默认值   说明
-----------------------------------------------------------------
00001        M1        系统启动状态   BOOL      FALSE   TRUE=系统正常运行
00002        M2        相机连接状态   BOOL      FALSE   TRUE=相机连接正常
00010        M10       检测完成信号   BOOL      FALSE   TRUE=单次检测完成

2.2 离散输入区域 (Discrete Input - 1x区域)
    用途：接收PLC控制指令

-----------------------------------------------------------------
Modbus地址   PLC地址   变量名称      数据类型   默认值   说明
-----------------------------------------------------------------
10001        I1        触发拍照       BOOL      FALSE   TRUE=触发视觉检测
10002        I2        系统复位       BOOL      FALSE   TRUE=复位检测状态

2.3 输入寄存器区域 (Input Register - 3x区域)
    用途：输出检测结果数据，PLC只读

-----------------------------------------------------------------
Modbus地址    PLC地址   变量名称      数据类型   默认值   单位   说明
-----------------------------------------------------------------
30200         IW200     检测结果X坐标  INT16     0       像素   目标中心X坐标
30201         IW201     检测结果Y坐标  INT16     0       像素   目标中心Y坐标
30300-30301   ID300     检测合格率    FLOAT     0.0     %      IEEE754格式，占2个寄存器

2.4 保持寄存器区域 (Holding Register - 4x区域)
    用途：参数设置，PLC可读写

-----------------------------------------------------------------
Modbus地址   PLC地址   变量名称   数据类型   默认值   单位   范围        说明
-----------------------------------------------------------------
40100        MW100     曝光时间    UINT16    1000    μs    100-10000   相机曝光时间
40101        MW101     增益值      UINT16    100     -     100-1000    相机增益倍数

=================================================================
3. 数据类型说明
=================================================================

3.1 基本数据类型
-----------------------------------------------------------------
数据类型     字节数    寄存器数    值范围               说明
-----------------------------------------------------------------
BOOL         1 bit     -          TRUE/FALSE          布尔值
INT16        2         1          -32768 ~ 32767      有符号16位整数
UINT16       2         1          0 ~ 65535           无符号16位整数
FLOAT        4         2          IEEE754             32位浮点数

3.2 浮点数存储格式（支持4种字节序，非常重要！）
-----------------------------------------------------------------

【ABCD格式（大端序，Modbus标准）】
地址N:   AB (高字节A + 低字节B)
地址N+1: CD (高字节C + 低字节D)
适用：西门子、三菱、欧姆龙等大部分PLC

【BADC格式（字节内交换）】
地址N:   BA (高字节B + 低字节A)
地址N+1: DC (高字节D + 低字节C)
适用：AB(Allen-Bradley)等部分美系PLC

【CDAB格式（寄存器交换）】
地址N:   CD (高字节C + 低字节D)
地址N+1: AB (高字节A + 低字节B)
适用：台达、信捷等部分PLC

【DCBA格式（完全反序）】
地址N:   DC (高字节D + 低字节C)
地址N+1: BA (高字节B + 低字节A)
适用：部分特殊PLC

示例：检测合格率 = 95.5% (IEEE754: 0x42BF8000)
ABCD: 地址30300=0x42BF, 地址30301=0x8000
BADC: 地址30300=0xBF42, 地址30301=0x0080
CDAB: 地址30300=0x8000, 地址30301=0x42BF
DCBA: 地址30300=0x0080, 地址30301=0xBF42

注意：必须选择正确的字节序格式，否则浮点数读取会出现严重错误！

=================================================================
4. 字节序配置说明（新增功能）
=================================================================

4.1 配置方法（升级为4种格式）
-----------------------------------------------------------------
1. 在VisionLite通讯配置界面中选择"ModbusTCP服务器"
2. 在参数设置区域找到"字节序"下拉菜单
3. 选择适合您PLC的字节序格式：
   - ABCD（大端序，标准）：适用于大多数Modbus标准设备
   - BADC（字节内交换）：适用于AB等美系PLC
   - CDAB（寄存器交换）：适用于台达、信捷等PLC
   - DCBA（完全反序）：适用于特殊要求的PLC

4.2 常见PLC厂商字节序（支持4种格式）
-----------------------------------------------------------------
PLC厂商                  推荐字节序格式
-----------------------------------------------------------------
西门子(Siemens)         ABCD（大端序，标准）
三菱(Mitsubishi)        ABCD（大端序，标准）
欧姆龙(Omron)           ABCD（大端序，标准）
施耐德(Schneider)       ABCD（大端序，标准）
AB(Allen-Bradley)       BADC（字节内交换）
台达(Delta)             CDAB（寄存器交换）
信捷(XinJe)             CDAB（寄存器交换）
部分国产PLC             DCBA（完全反序）

4.3 字节序验证方法（4格式快速测试）
-----------------------------------------------------------------
1. 使用标准测试值：写入浮点数100.5到地址30300-30301
2. 通过PLC或HslCommunication等工具读取该地址的原始寄存器值
3. 对比期望值判断字节序格式：
   - 如果寄存器值为 [0x42C9, 0x0000] → 使用ABCD格式
   - 如果寄存器值为 [0xC942, 0x0000] → 使用BADC格式  
   - 如果寄存器值为 [0x0000, 0x42C9] → 使用CDAB格式
   - 如果寄存器值为 [0x0000, 0xC942] → 使用DCBA格式
4. 设置正确格式后重新测试，确保PLC读取到100.5

=================================================================
5. 通讯时序
=================================================================

5.1 标准检测流程
-----------------------------------------------------------------

PLC端                           VisionLite端
-----------------------------------------------------------------
1. 系统初始化
读取系统启动状态 (00001) -->    返回TRUE (系统就绪)

2. 设置参数  
写入曝光时间 (40100) = 1500 --> 确认写入成功
写入增益值 (40101) = 200 -->    确认写入成功

3. 执行检测
写入触发拍照 (10001) = TRUE --> 确认写入成功
                                执行图像处理...
<-- 检测完成信号 (00010) = TRUE

4. 读取结果
读取X坐标 (30200) -->           返回X坐标值
读取Y坐标 (30201) -->           返回Y坐标值  
读取合格率 (30300-30301) -->    返回浮点数值

5. 复位准备下次
写入系统复位 (10002) = TRUE --> 检测完成信号 (00010) = FALSE

5.2 建议轮询周期
-----------------------------------------------------------------
数据类型        建议周期    说明
-----------------------------------------------------------------
状态监控        100ms      系统状态、连接状态
结果读取        50ms       检测完成后的结果获取
参数设置        按需       仅在需要调整时写入

=================================================================
6. PLC编程示例
=================================================================

6.1 西门子S7-1200/1500 (SCL语言)
-----------------------------------------------------------------
// 读取系统状态
"DB_Vision".SystemReady := "MB_Client_1".x01_ReadCoils(
    REQ := TRUE,
    ADDR := 1,      // 地址00001
    LEN := 1
);

// 触发检测
"MB_Client_1".x05_WriteSingleCoil(
    REQ := #TriggerDetection,
    ADDR := 10001,  // 地址10001  
    DATA := TRUE
);

// 读取检测结果
"DB_Vision".ResultX := "MB_Client_1".x04_ReadInputRegs(
    ADDR := 200,    // 地址30200
    LEN := 1
);

6.2 三菱FX系列
-----------------------------------------------------------------
// 触发检测
D100 = 1        // 写入值TRUE
TO K502 K10001 K1 D100    // 写单个线圈

// 读取X坐标  
FROM K502 K30200 K1 D200  // 读输入寄存器到D200

6.3 欧姆龙CP1H/CJ2M
-----------------------------------------------------------------
// ModbusTCP功能块调用
ModbusTCP_Read(
    Enable := TRUE,
    ServerIP := '192.168.1.100',
    ServerPort := 502,
    UnitID := 1,
    Function := 3,        // 读保持寄存器
    Address := 30200,     // 读X坐标
    Quantity := 1,
    pData := ADR(ResultData)
);

=================================================================
7. 故障排除
=================================================================

7.1 连接问题
-----------------------------------------------------------------
故障现象            可能原因            解决方案
-----------------------------------------------------------------
无法连接服务器      IP地址错误          检查网络配置，ping测试
连接超时           防火墙阻止          开放502端口
连接断开           网络不稳定          检查网线、交换机

7.2 数据异常
-----------------------------------------------------------------
故障现象            可能原因            解决方案
-----------------------------------------------------------------
读取数据全为0       地址偏移错误        确认地址映射表
浮点数异常         字节序错误          检查字节序格式配置
写入无效果         功能码错误          确认读写权限
浮点数值严重错误   字节序格式错误       尝试ABCD/BADC/CDAB/DCBA格式
浮点数为随机值     字节序格式不匹配     参考4.3节快速验证方法

7.3 性能优化
-----------------------------------------------------------------
- 批量读取：优先使用批量读取减少通讯次数
- 地址连续：相关数据安排在连续地址提高效率  
- 轮询优化：根据数据重要性调整轮询频率
- 异常处理：添加通讯超时和重连机制
- 字节序匹配：选择正确的4种字节序格式之一，避免数据转换错误

=================================================================
8. 测试验证
=================================================================

8.1 连通性测试
-----------------------------------------------------------------
方法1：使用telnet测试端口连通性
命令：telnet 192.168.1.100 502

方法2：使用ModbusPoll等工具测试
地址：192.168.1.100:502
从站ID：1

8.2 数据验证
-----------------------------------------------------------------
测试项              测试方法           预期结果
-----------------------------------------------------------------
系统状态读取        读取00001地址       返回TRUE
参数写入           写入40100=2000     成功写入
结果读取           读取30200-30201    获取坐标值
浮点数解析         读取30300-30301    正确解析百分比
字节序验证         写入已知浮点数      PLC读取值正确

8.3 字节序格式测试步骤（4格式完整验证）
-----------------------------------------------------------------
步骤1：准备测试
1. 启动VisionLite ModbusTCP服务器
2. 使用HslCommunication或PLC连接到服务器

步骤2：标准值测试  
3. 向地址30300-30301写入浮点数100.5 (0x42C90000)
4. 读取原始寄存器值并对照：
   - ABCD格式: reg[30300]=0x42C9, reg[30301]=0x0000  
   - BADC格式: reg[30300]=0xC942, reg[30301]=0x0000
   - CDAB格式: reg[30300]=0x0000, reg[30301]=0x42C9
   - DCBA格式: reg[30300]=0x0000, reg[30301]=0xC942

步骤3：验证读取
5. 在VisionLite中切换到对应的字节序格式
6. 重新读取地址30300-30301，确认值为100.5
7. 测试其他浮点数值（如95.5、123.456）进行二次验证

步骤4：PLC程序验证
8. 在PLC程序中读取浮点数，确认数值正确
9. 记录该PLC适用的字节序格式供后续使用

=================================================================
9. 配置文件说明
=================================================================

9.1 地址映射配置文件
-----------------------------------------------------------------
文件名：modbus_default.json
位置：VisionLite\bin\Debug\
说明：包含所有地址映射定义，可根据需要修改

9.2 字节序配置（升级支持4种格式）
-----------------------------------------------------------------
配置项：DataByteOrder
可选值：
  - 0: ABCD (大端序，Modbus标准，默认)
  - 1: BADC (字节内交换)
  - 2: CDAB (寄存器交换)  
  - 3: DCBA (完全反序)

=================================================================
10. 联系信息
=================================================================

10.1 技术支持
-----------------------------------------------------------------
系统负责人：[您的姓名]
联系电话：[您的电话]  
邮箱：[您的邮箱]
技术文档：本文档及相关配置文件

10.2 变更记录
-----------------------------------------------------------------
版本   日期        变更内容                    修改人
-----------------------------------------------------------------
v1.0   2025-08-26  初始版本，定义基础地址映射   Claude
v1.1   2025-08-26  增加字节序配置支持          Claude  
v1.2   2025-08-26  升级支持4种字节序格式       Claude

=================================================================
重要提醒
=================================================================

1. 请在实际部署前进行充分的连通性和功能测试
2. 地址映射表可根据实际需求调整，但需双方确认
3. 建议建立测试环境进行验证后再投入生产使用
4. 如需修改地址映射，请更新配置文件：modbus_default.json
5. 字节序格式配置对浮点数读取至关重要，必须选择4种格式中的正确一种
6. 建议在测试阶段使用标准值100.5验证字节序格式，参考第8.3节详细步骤  
7. 不同PLC厂商有不同的字节序格式要求，请严格参考第4.2节推荐配置
8. 错误的字节序格式会导致浮点数完全错乱，务必进行充分测试验证

=================================================================